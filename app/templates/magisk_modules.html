{% extends 'base.html' %} {% load static %} {% block style %}
<style>

 #searching .btn{

border-radius: 10px;
background-color: var(--primary);
border: none;
color: var(--text);

}



#searching .active{

background: var(--secondary) ;
border-color: #3b3b4f3a ;
color: #ffffff ;
    font-size: 12px;
}

#searching .inputs{

position: relative;

}
#searching .inputs .input-wrapper {
    opacity: 1;
}
.bg-primary {
    background-color: #3b3b4f3a; /* Replace with your desired color */
}
#searching .inputs input {
    opacity: 1;
}

#searching .form-control {
    text-indent: 15px;
border: none;
height: 45px;
border-radius: 0px;
border-bottom: 1px solid #eee;
}

#searching .form-control:focus {
color: #495057;
background-color: #fff;
border-color: #eee;
outline: 0;
box-shadow: none;
border-bottom: 1px solid blue;
}


#searching .form-control:focus  {
color: blue;
}

#searching .inputs i{

    position: absolute;
top: 14px;
left: 4px;
color: #b8b9bc;
}

.text-center {
    font-size: 3em;
    font-weight: bold;
    color: var(--text);
    background: linear-gradient(120deg, var(--primary), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  @media only screen and (max-width: 757px) {
    .text-center{
      font-size: 1.5em;
    }
  }
</style>
{% endblock %} {% block content %}

<div class="container py-5">
  <h1 class="text-center mb-5">Mods And Tools Showcase</h1>

  <!-- Search Bar -->
  <section id="searching">
  <div class="d-flex justify-content-between align-items-center">
    {% if user.is_authenticated and user.userprofile.is_authorized %}
    <span class="font-weight-bold">You can upload stuffs &rarr;</span>
    {% else %}
    <span class="font-weight-bold">You are not authorised to upload mods</span>
    {% endif %}
    <div class="d-flex flex-row">
    </div>
      <a class="btn btn-primary mod-link button" data-bs-toggle="modal" data-bs-target="#uploadModal">Upload mods</a>
      
    </div>

<div class="mt-3 inputs" style="padding-bottom: 40px;">
  <i class="fa fa-search" style="margin-left: 1em;"></i>
  <input
      id="search-input"
      type="text"
      class="form-control live-search"
      placeholder="Search Custom mods..."
      style="padding: 1em 2em; border-radius: 10px; border: none; background-color: var(--secondary); color: var(--text)">
</div>

<div id="search-results" class="row row-cols-1 row-cols-md-3 g-4" style="padding-bottom: 20px;">
</div>

</section>


  <!------------------------------------ Custom mod cards ----------------------------------------------------->
 
 
  <div class="row row-cols-1 row-cols-md-3 g-4">
    {% for mod in mods %}
    <div class="col mod-card">
      <div class="card h-100">
        <img
          src="{{ mod.image.url }}"
          class="img-thumbnail custom-mod-image"
          alt="{{ mod.name }}"
        />
        <div class="card-body">
          <h5 class="card-title">
            {{ mod.name }} &rarr; {{ mod.device }} <br />
            <a
              href="https://telegram.me/{{mod.credits}}"
              target="_blank"
              style="text-decoration: none"
              >@{{mod.credits}}</a
            >
          </h5>
          <h5 class="card-title">
            Date: {{mod.upload_date}}
          </h5>
          <div class="buttons-wrapper">
            <a
              href="{{ mod.link }}"
              target="_blank"
              class="btn btn-primary mod-link"
              style="background-color: var(--accent); border: none;"
              >Download</a>
            {% if request.user.is_staff %}
            <a href="{% url 'edit_mod' mod.id %}" class="btn btn-primary"
              >Edit</a
            > </span>{% endif %}
              {% if request.user.is_authenticated %}
                  <button class="btn btn-secondary mod-link like-button"
                          data-mod-id="{{ mod.id }}"
                          style="float: right; margin-left: 5px;">
                      <i class="far fa-thumbs-up"></i>
                  </button>
                  <span class="btn btn-secondary mod-link likes-count" style="border-radius: 50%; float: right;">
                      {{ mod.likes.count }}
                  </span>
              {% else %}
                  <button class="btn btn-secondary mod-link like-button" data-bs-toggle="modal" data-bs-target="#loginModal">
                      <i class="far fa-thumbs-up"></i>
                  </button>
                  <span class="btn btn-secondary mod-link likes-count" style="border-radius: 50%;">
                      {{ mod.likes.count }}
                  </span>
              {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>


  
<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="loginModalLabel">Login Required</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              Please log in to use this feature and various other features.
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <a href="{% url 'login' %}" class="btn btn-primary">Log In</a>
          </div>
      </div>
  </div>
</div>


  <!---------------------------------- Upload mod Modal ---------------------------------------------->
  
  
  <div
    class="modal fade"
    id="uploadModal"
    tabindex="-1"
    aria-labelledby="uploadModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">Upload Custom mod</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %} {% if user.is_authenticated %} 
            {% if user.userprofile.is_authorized %}
            <div class="mb-3">
              <label for="name" class="form-label">Name</label>
              <input
                type="text"
                class="form-control"
                id="name"
                name="name"
                required
              />
            </div>
            <div class="mb-3">
              <label for="image" class="form-label">Credits</label>
              <input
                placeholder="Just write telegram username ! (no '@')"
                type="text"
                class="form-control"
                id="credits"
                name="credits"
                required
              />
            </div>
            <div class="mb-3">
              <label for="image" class="form-label">Image</label>
              <input
                type="file"
                accept="image/*"
                class="form-control"
                id="image"
                name="image"
                required
              />
            </div>
            <div class="mb-3">
              <label for="link" class="form-label">MOD / Tool Link</label>
              <input
                type="url"
                class="form-control"
                id="link"
                name="link"
                required
              />
              <div>
                <label for="date" class="form-label">Release Date</label>
                <input
                type="date"
                class="form-control"
                id="upload_date"
                name="upload_date"
                required
              />
              </div>
            </div>
            <div class="mb-3">
              <label for="details" class="form-label">Details</label>
              <textarea
                class="form-control"
                id="details"
                name="details"
                rows="3"
                required
              ></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Upload</button>
            {% else %}
            <p class="text-warning">
              You are not authorized to upload mods. Kindly send a request to
              Siddharth or Staff Members on telegram or by other sources to get
              authorized.
            </p>
            {% endif %} 
            {% else %}
            <p class="text-warning">Please log in to upload mods.</p>
            {% endif %}
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} 

<!----------------------------------------JAVASCRIPT code---------------------------------------------------------->

{% block script %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function ()  {
  const searchInput = $('#search-input');
  const searchResults = $('#search-results');

  searchInput.on('input', function() {
      const query = $(this).val().trim();
      if (query.length >= 2) {
          fetchSearchResults(query);
      } else {
          clearSearchResults();
      }
  });

  function fetchSearchResults(query) {
      $.ajax({
          url: "{% url 'search_custom_mods' %}",
          data: {'q': query},
          dataType: 'json',  // Expect JSON response
          success: function(data) {
              displaySearchResults(data.results); // Pass the results array
          },
          error: function() {
              console.log("An error occurred while fetching search results.");
          }
      });
  }
  function displaySearchResults(results) {
    searchResults.empty();
    if (results.length > 0) {
      const searchResults = document.getElementById('search-results'); // Replace with your actual element ID
      
for (const result of results) {
    const editLink = result.is_staff ? `
        <a href="" class="btn btn-primary edit-link" data-mod-id="${result.id}">Edit</a>
    ` : '';
    const likeBtn = result.is_authenticated ?
    `<button class="btn btn-secondary mod-link like-button"
             data-mod-id="${result.id}"
             style="float: right; margin-left: 5px;">
        <i class="far fa-thumbs-up"></i>
    </button>` :
    `<button class="btn btn-secondary mod-link like-button" data-bs-toggle="modal" data-bs-target="#loginModal">`;
    const likeCnt = result.is_authenticated ?
    `<span class="btn btn-secondary mod-link likes-count" style="border-radius: 50%; float: right;">
                            ${result.likes}
                        </span>` :
    `<span class="btn btn-secondary mod-link likes-count" style="border-radius: 50%; float: right;">
                            ${result.likes}
                        </span>`;


    const resultHtml = `
    <div class="col mod-card">
        <div class="card h-100">
            <img
                src="${result.image_url}"
                class="img-thumbnail custom-mod-image"
                alt="${result.name}"
            />
            <div class="card-body">
                <h5 class="card-title">
                    ${result.name} &rarr; ${result.device} <br />
                    <a
                        href="https://telegram.me/${result.credits}"
                        target="_blank"
                    >@${result.credits}</a>
                </h5>
                <h5 class="card-title">
                    Date: ${result.upload_date}
                </h5>
                <div class="buttons-wrapper">
                        <a
                            href="${result.link}"
                            target="_blank"
                            class="btn btn-primary mod-link"
                            style="background-color: var(--accent); border: none;"
                        >Download</a>
                        ${editLink}
                        ${likeBtn}
                        ${likeCnt}
                    </div>
            </div>
        </div>
    </div>
`;
    searchResults.innerHTML += resultHtml;
}
    } else {
        searchResults.append("<p>No results found (Check Typos..)</p>");
    }
    $('.edit-link').click(function(e) {
        e.preventDefault();
        const modId = $(this).data('mod-id');
        const editUrl = `{% url 'edit_mod' 0 %}`.replace('0', modId);
        window.location.href = editUrl;
    });
}

  function clearSearchResults() {
      searchResults.empty();
  }
});

</script>

<!-------------------------------------mod likes count Script---------------------------------------------------->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    $(document).on("click", ".like-button", function () {
      var modId = $(this).data("mod-id");
      var likesCountElement = $(this).siblings(".likes-count");
      var icon = $(this).find("i");

      $.ajax({
        type: "POST",
        url: window.location.href,
        data: {
          'mod_id': modId,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function (data) {
          // Update the displayed likes count directly
          likesCountElement.text(data.likes);

          // Toggle the filled/empty thumbs-up icon based on the response
          if (icon.hasClass("far")) {
            icon.removeClass("far").addClass("fas");
          } else {
            icon.removeClass("fas").addClass("far");
          }
        }
      });
    });
  });
</script>



<!------------------------------------cookie collecting in all pages------------------------------------------------>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modLinks = document.querySelectorAll(".mod-link");

    modLinks.forEach((modLink) => {
      modLink.addEventListener("click", function (event) {
        const modId = event.target.dataset.modId;
        const interactionData = `User clicked on mod with ID ${mod.id}`;

        // Send interaction data to the set_cookie view using AJAX
        fetch(`/set-cookie/?interaction_data=${interactionData}`)
          .then((response) => response.json())
          .then((data) => console.log(data.message));
      });
    });
  });
</script>

<!-----------------------------------------Session Traking--------------------------------------------------------->

<script>
  document.querySelectorAll(".track-session-link").forEach(function (link) {
    link.addEventListener("click", function (event) {
      event.preventDefault();
      var url = this.getAttribute("href");
      fetch(url).then(function (response) {
        if (response.ok) {
          alert("Session tracked for this mod!");
        } else {
          alert("Failed to track session. Please try again later.");
        }
      });
    });
  });
</script>

{% endblock %}
