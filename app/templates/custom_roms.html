{% extends 'base.html' %} {% load static %} {% block style %}
<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Include Select2 CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0/css/select2.min.css" rel="stylesheet" />
<style>

#jas .btn {
        background-color: var(--accent) !important ;
        color: var(--background) !important;
        border: none !important;
        border-radius: 20px !important;
      }

  #searching .active {

    background: var(--secondary);
    border-color: #3b3b4f3a;
    color: #ffffff;
    font-size: 12px;
  }

  #searching .inputs {

    position: relative;

  }

  #searching .inputs .input-wrapper {
    opacity: 1;
  }

  .bg-primary {
    background-color: #3b3b4f3a;
    /* Replace with your desired color */
  }

  #searching .inputs input {
    opacity: 1;
  }

  #searching .form-control {
    text-indent: 15px;
    border: none;
    height: 45px;
    border-radius: 0px;
    border-bottom: 1px solid #eee;
  }

  #searching .form-control:focus {
    color: #495057;
    background-color: #fff;
    border-color: #eee;
    outline: 0;
    box-shadow: none;
    border-bottom: 1px solid blue;
  }


  #searching .form-control:focus {
    color: blue;
  }

  #searching .inputs i {

    position: absolute;
    top: 14px;
    left: 4px;
    color: #b8b9bc;
  }

  .text-center {
    font-size: 3em;
    font-weight: bold;
    color: var(--text);
    background: linear-gradient(120deg, var(--primary), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  @media only screen and (max-width: 757px) {
    .text-center {
      font-size: 1.5em;
    }

    .button {
      width: 100%;
    }

    .side-text {
      display: none;
    }
  }
</style>
{% endblock %} {% block content %}

<div class="container py-5">
  <h1 class="text-center mb-5">Custom ROM Showcase</h1>

  <!-- Search Bar -->
  <section id="searching">
    <div class="d-flex justify-content-between align-items-center">
      {% if user.is_authenticated and user.userprofile.is_authorized %}
      <span class="font-weight-bold side-text">You can upload stuffs &rarr;</span>
      {% else %}
      <span class="font-weight-bold side-text">You are not authorised to upload Roms</span>
      {% endif %}
      <div class="d-flex flex-row">
      </div>
      <a class="btn btn-primary rom-link button" data-bs-toggle="modal" data-bs-target="#uploadModal">Upload Roms</a>
    </div>

    <div class="mt-3 inputs" style="padding-bottom: 40px;">
      <div style="position: relative;">
          <input id="search-input" type="text" class="form-control live-search" placeholder="Search Custom ROMs and Recovery..."
              style="padding: 1em 2em; border-radius: 20px; border: none; background-color: var(--secondary); color: var(--text); text-indent: 30px;">
          <i class="fa fa-search" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%);"></i>
      </div>
  </div>
  </section>

  <div id="search-results" class="row row-cols-1 row-cols-md-3 g-4" style="padding-bottom: 20px;">
  </div>


  <!------------------------------------ Custom ROM cards ----------------------------------------------------->


  <div class="row row-cols-1 row-cols-md-3 g-4">
    {% for rom in roms %}
    <div class="col rom-card">
      <div class="card h-100">
        <img src="{{ rom.image.url }}" class="img-thumbnail custom-rom-image" alt="{{ rom.name }}" />
        <div class="card-body">
          <h5 class="card-title">
            {{ rom.name }} &rarr; {{ rom.device }} <br />
            <a href="https://telegram.me/{{rom.credits}}" target="_blank"
              style="text-decoration: none">@{{rom.credits}}</a>
          </h5>
          <h5 class="card-title">
            Date: {{rom.upload_date}}
          </h5>
          <h5 class="card-title">
            Details : <a href="{% url 'rom_details' rom.id %}">Visit Here</a>
          </h5>
          <div class="buttons-wrapper">
            <a href="{{ rom.link }}" target="_blank" class="jas btn btn-primary rom-link">Download</a>
            {% if request.user.is_staff %}
            <a href="{% url 'edit_rom' rom.id %}" class="jas btn btn-primary">Edit</a>{% endif %}
            {% if request.user.is_authenticated %}
            <button class="btn btn-secondary rom-link like-button" data-rom-id="{{ rom.id }}"
              style="float: right; margin-left: 5px;">
              <i class="far fa-thumbs-up"></i>
            </button>
            <span class="btn btn-secondary rom-link likes-count" style="float: right;">
              {{ rom.likes.count }}
            </span>
            {% else %}
            <button class="btn btn-secondary rom-link like-button" data-bs-toggle="modal" data-bs-target="#loginModal">
              <i class="far fa-thumbs-up"></i>
            </button>
            <span class="btn btn-secondary rom-link likes-count">
              {{ rom.likes.count }}
            </span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>



  <!----------------------------------- Login Modal -------------------------------------------------->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Login Required</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Please log in to use this feature and various other features.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <a href="{% url 'login' %}" class="btn btn-primary">Log In</a>
        </div>
      </div>
    </div>
  </div>

  <!---------------------------------- Upload ROM Modal ---------------------------------------------->


  <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">Upload Custom ROM</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %} {% if user.is_authenticated %}
            {% if user.userprofile.is_authorized %}
            <div class="mb-3">
              <label for="name" class="form-label">Name</label>
              <input type="text" class="form-control" id="name" name="name" required />
            </div>
            <div class="mb-3">
              <label for="device" class="form-label">Device</label>
              <select class="form-select" id="device" name="device" required>
                <option value="" selected disabled>Select a Device</option>
                <option value="Fleur / Miel">Fleur / Miel</option>
                <option value="Viva / Vida">Viva / Vida</option>
                <option value="Ocean / Sea">Ocean / Sea</option>
                <option value="Ocean / Sea">Blossom</option>
                <option value="Ocean / Sea">Lavander</option>
                <option value="Ocean / Sea">Ginkgo / Willow</option>
                <option value="Ocean / Sea">X01BD</option>
                <option value="Vince">Vince</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="image" class="form-label">Credits</label>
              <input placeholder="Just write telegram username ! (no '@')" type="text" class="form-control" id="credits"
                name="credits" required />
            </div>
            <div class="mb-3">
              <label for="image" class="form-label">Image</label>
              <input type="file" accept="image/*" class="form-control" id="image" name="image" required />
            </div>
            <div class="mb-3">
              <label for="link" class="form-label">ROM / Recovery Link</label>
              <input type="url" class="form-control" id="link" name="link" required />
              <div class="mb-3">
                <label for="link" class="form-label">Boot-Img Link (optional)</label>
                <input type="url" class="form-control" id="boot_link" name="boot_link" />
                <div>
                  <label for="date" class="form-label">Release Date</label>
                  <input type="date" class="form-control" id="upload_date" name="upload_date" required />
                </div>
              </div>
              <div class="mb-3">
                <label for="details" class="form-label">Details</label>
                <textarea class="form-control" id="details" name="details" rows="3" required></textarea>
              </div>
              <button type="submit" class="btn btn-primary">Upload</button>
              {% else %}
              <p class="text-warning">
                You are not authorized to upload ROMs. Kindly send a request to
                Siddharth or Staff Members on telegram or by other sources to get
                authorized.
              </p>
              {% endif %}
              {% else %}
              <p class="text-warning">Please log in to upload ROMs.</p>
              {% endif %}
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

<!-----------------------------JAVASCRIP code---------------------------------------------------------->

{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0/js/select2.min.js"></script>
<script>
  $(document).ready(function () {
    // Initialize Select2 on the select element
    $('#device').select2({
      matcher: function (term, text, option) {
        return text.toUpperCase().indexOf(term.toUpperCase()) >= 0 || option.val().toUpperCase().indexOf(term.toUpperCase()) >= 0;
      }
    });
  });
</script>


<!-------------------------------------Searching Content----------------------------------------------->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.querySelector("#search-input");
    const searchButton = document.querySelector("#search-button");
    const romCards = document.querySelectorAll(".rom-card");

    searchButton.addEventListener("click", function () {
      const query = searchInput.value.toLowerCase().trim();

      romCards.forEach((card) => {
        const cardTitle = card
          .querySelector(".card-title")
          .textContent.toLowerCase();

        if (cardTitle.includes(query)) {
          card.style.display = "block";
        } else {
          card.style.display = "none";
        }
      });
    });
  });
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = $('#search-input');
    const searchResults = $('#search-results');

    searchInput.on('input', function () {
      const query = $(this).val().trim();
      if (query.length >= 2) {
        fetchSearchResults(query);
      } else {
        clearSearchResults();
      }
    });

    function fetchSearchResults(query) {
      $.ajax({
        url: "{% url 'search_custom_roms' %}",
        data: { 'q': query },
        dataType: 'json',  // Expect JSON response
        success: function (data) {
          displaySearchResults(data.results); // Pass the results array
        },
        error: function () {
          console.log("An error occurred while fetching search results.");
        }
      });
    }

    function displaySearchResults(results) {
      searchResults.empty();
      if (results.length > 0) {
        const searchResults = document.getElementById('search-results'); // Replace with your actual element ID

        for (const result of results) {
          const editLink = result.is_staff ? `
            <a href="" class="btn btn-primary edit-link" data-rom-id="${result.id}">Edit</a>
        ` : '';

        const likeBtn = result.is_authenticated ?
            `<button class="btn btn-secondary rom-link like-button" data-rom-id="${result.id}" style="float:right;margin-right: 5px;">
                <i class="far fa-thumbs-up"></i>
            </button>` :
            `<button class="btn btn-secondary rom-link like-button" data-bs-toggle="modal" data-bs-target="#loginModal" style="float:right;margin-right: 5px;">
                <i class="far fa-thumbs-up"></i>
            </button>`;

        const likeCnt = `
            <span class="btn btn-secondary rom-link likes-count" style="border-radius: 50%;float:right;">
                ${result.likes}
            </span>`;

        const romDetails = `<h5 class="card-title">
            Details : <a href="" class="rom-details" data-rom-id="${result.id}">Visit Here</a>
        </h5>`;


          const resultHtml = `
    <div class="col rom-card">
        <div class="card h-100">
            <img
                src="${result.image_url}"
                class="img-thumbnail custom-rom-image"
                alt="${result.name}"
            />
            <div class="card-body">
                <h5 class="card-title">
                    ${result.name} &rarr; ${result.device} <br />
                    <a
                        href="https://telegram.me/${result.credits}"
                        target="_blank"
                    >@${result.credits}</a>
                    </h5>
                    <h5 class="card-title">
                        Date: ${result.upload_date}
                    </h5>
                    ${romDetails}
                    <div class="buttons-wrapper">
                        <a
                            href="${result.link}"
                            target="_blank"
                            class="btn btn-primary rom-link"
                            style="background-color: var(--accent); border: none;"
                        >Download</a>
                        ${editLink}
                        ${likeCnt}
                        ${likeBtn}
                    </div>
            </div>
        </div>
    </div>
`;
          searchResults.innerHTML += resultHtml;
        }

      } else {
        searchResults.append("<p>No results found (Check Typos..)</p>");
      }
      $('.edit-link').click(function (e) {
        e.preventDefault();
        const romId = $(this).data('rom-id');
        const editUrl = `{% url 'edit_rom' 0 %}`.replace('0', romId);
        window.location.href = editUrl;
      });
      $('.rom-details').click(function (e) {
        e.preventDefault();
        const romId = $(this).data('rom-id');
        const editUrl = `{% url 'rom_details' 0 %}`.replace('0', romId);
        window.location.href = editUrl;
      });
    }

    function clearSearchResults() {
      searchResults.empty();
    }
  });

</script>

<!---------------------------ROM likes count Script---------------------------------------------------->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    $(document).on("click", ".like-button", function () {
      var romId = $(this).data("rom-id");
      var likesCountElement = $(this).siblings(".likes-count");
      var icon = $(this).find("i");

      $.ajax({
        type: "POST",
        url: window.location.href,
        data: {
          'rom_id': romId,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function (data) {
          // Update the displayed likes count directly
          likesCountElement.text(data.likes);

          // Toggle the filled/empty thumbs-up icon based on the response
          if (icon.hasClass("far")) {
            icon.removeClass("far").addClass("fas");
          } else {
            icon.removeClass("fas").addClass("far");
          }
        }
      });
    });
  });
</script>



<!-----------------------cookie collecting in all pages------------------------------------------------>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const romLinks = document.querySelectorAll(".rom-link");

    romLinks.forEach((romLink) => {
      romLink.addEventListener("click", function (event) {
        const romId = event.target.dataset.romId;
        const interactionData = `User clicked on ROM with ID ${rom.id}`;

        // Send interaction data to the set_cookie view using AJAX
        fetch(`/set-cookie/?interaction_data=${interactionData}`)
          .then((response) => response.json())
          .then((data) => console.log(data.message));
      });
    });
  });
</script>

<!------------------------------Session Traking--------------------------------------------------------->

<script>
  document.querySelectorAll(".track-session-link").forEach(function (link) {
    link.addEventListener("click", function (event) {
      event.preventDefault();
      var url = this.getAttribute("href");
      fetch(url).then(function (response) {
        if (response.ok) {
          alert("Session tracked for this ROM!");
        } else {
          alert("Failed to track session. Please try again later.");
        }
      });
    });
  });
</script>

{% endblock %}